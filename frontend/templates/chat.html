{% extends "base.html" %}

{% block title %}Chat - LUCA{% endblock %}

{% block content %}
<div class="header-brand">
    <div class="container">
        <div class="row align-items-center">
            <div class="col">
                <div class="d-flex align-items-center">
                    <h2 class="mb-0">LUCA - Asistente Educativo</h2>
                </div>
            </div>
            <div class="col-auto">
                <span class="me-3">{{ user_email }}</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-3">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <!-- FICA Logo -->
            <div class="text-center mb-3">
                <img src="{{ url_for('static', filename='images/Logo FICA uso excepcional color.png') }}" alt="FICA Logo" style="height: 100px;">
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-comments"></i> Conversaciones</h5>
                    <button class="btn btn-primary btn-sm w-100 mt-2" onclick="createNewConversation()">
                        <i class="fas fa-plus"></i> Nueva Conversaci√≥n
                    </button>
                </div>
                <div class="card-body" id="conversationsList">
                    {% for conv in conversations %}
                    <div class="conversation-item" data-id="{{ conv.id }}" onclick="selectConversation('{{ conv.id }}')">
                        <div class="fw-bold">{{ conv.title[:60] }}{% if conv.title|length > 60 %}...{% endif %}</div>
                        <small class="text-muted">
                            {{ conv.subject or 'Sin materia' }} ‚Ä¢ {{ conv.message_count }} mensajes
                        </small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='images/logo luca.png') }}" alt="LUCA Logo" class="me-2" style="height: 120px;">
                                <h5 class="mb-0">LUCA - Seleccion√° la materia</h5>
                            </div>
                        </div>
                        <div class="col-auto">
                            <select class="form-select form-select-sm" id="subjectSelect">
                                <option value="">Selecciona una materia...</option>
                                {% for subject in subjects %}
                                <option value="{{ subject }}">{{ subject }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Chat Messages Container -->
                    <div class="chat-container" id="chatContainer">
                        <div class="text-center text-muted">
                            <i class="fas fa-comment-dots fa-2x mb-2"></i>
                            <p>¬°Hola! Soy LUCA, tu asistente. ¬øEn qu√© puedo ayudarte hoy?</p>
                        </div>
                    </div>
                    
                    <!-- Progress Container -->
                    <div class="progress-container" id="progressContainer"></div>
                    
                    <!-- Chat Input -->
                    <form id="chatForm" class="mt-3">
                        <div class="input-group">
                            <textarea class="form-control" id="messageInput" rows="2" 
                                      placeholder="Escribe tu pregunta aqu√≠..." required></textarea>
                            <button class="btn btn-primary" type="submit" id="sendBtn">
                                <span class="btn-text"><i class="fas fa-paper-plane"></i> Enviar</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
        
        <!-- Symbols Panel -->
        <div class="col-md-3">
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-calculator"></i> S√≠mbolos</h5>
                </div>
                <div class="card-body p-0">
                    <!-- Nav tabs -->
                    <ul class="nav nav-tabs" id="symbolsTabs" role="tablist">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active" id="algebra-tab" data-bs-toggle="tab" data-bs-target="#algebra" type="button" role="tab" aria-controls="algebra" aria-selected="true">
                                √Ålgebra Relacional
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link" id="math-tab" data-bs-toggle="tab" data-bs-target="#math" type="button" role="tab" aria-controls="math" aria-selected="false">
                                Matem√°ticas
                            </button>
                        </li>
                    </ul>
                    
                    <!-- Tab content -->
                    <div class="tab-content" id="symbolsTabContent">
                        <!-- Algebra Relacional Tab -->
                        <div class="tab-pane fade show active" id="algebra" role="tabpanel" aria-labelledby="algebra-tab">
                            <div class="symbols-container p-2">
                                <h6 class="mb-2">Operadores B√°sicos</h6>
                                <div class="symbols-grid mb-3">
                                    <button class="symbol-btn" data-symbol="œÉ" title="Selecci√≥n (sigma)">œÉ</button>
                                    <button class="symbol-btn" data-symbol="œÄ" title="Proyecci√≥n (pi)">œÄ</button>
                                    <button class="symbol-btn" data-symbol="‚ãà" title="Join natural">‚ãà</button>
                                    <button class="symbol-btn" data-symbol="‚à™" title="Uni√≥n">‚à™</button>
                                    <button class="symbol-btn" data-symbol="‚à©" title="Intersecci√≥n">‚à©</button>
                                    <button class="symbol-btn" data-symbol="‚àí" title="Diferencia">‚àí</button>
                                    <button class="symbol-btn" data-symbol="√ó" title="Producto cartesiano">√ó</button>
                                    <button class="symbol-btn" data-symbol="/" title="Divisi√≥n">/</button>
                                </div>
                                
                                <h6 class="mb-2">Expresiones Comunes</h6>
                                <div class="expressions-list">
                                    <button class="expression-btn" data-expression="œÄ_{Nombre} (œÉ_{Ciudad='Buenos Aires'} (CLIENTES))" title="Proyecci√≥n con selecci√≥n">
                                        œÄ_{atributo} (œÉ_{condici√≥n} (TABLA))
                                    </button>
                                    <button class="expression-btn" data-expression="œÉ_{A.campo>B.campo} (A‚ãà_{A.id=B.id} B)" title="Join con condici√≥n">
                                        Join con condici√≥n
                                    </button>
                                    <button class="expression-btn" data-expression="œÄ_{campo} (TABLA1) ‚àí œÄ_{campo} (TABLA2)" title="Diferencia de proyecciones">
                                        Diferencia de conjuntos
                                    </button>
                                    <button class="expression-btn" data-expression="œÄ_{A,B} (TABLA) / œÄ_{B} (OTRA_TABLA)" title="Cociente de Conjuntos">
                                        Cociente de Conjuntos
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Matem√°ticas Tab -->
                        <div class="tab-pane fade" id="math" role="tabpanel" aria-labelledby="math-tab">
                            <div class="symbols-container p-2">
                                <h6 class="mb-2">S√≠mbolos Matem√°ticos</h6>
                                <div class="symbols-grid mb-3">
                                    <button class="symbol-btn" data-symbol="‚àÄ" title="Para todo">‚àÄ</button>
                                    <button class="symbol-btn" data-symbol="‚àÉ" title="Existe">‚àÉ</button>
                                    <button class="symbol-btn" data-symbol="‚àà" title="Pertenece">‚àà</button>
                                    <button class="symbol-btn" data-symbol="‚àâ" title="No pertenece">‚àâ</button>
                                    <button class="symbol-btn" data-symbol="‚äÜ" title="Subconjunto">‚äÜ</button>
                                    <button class="symbol-btn" data-symbol="‚äÇ" title="Subconjunto propio">‚äÇ</button>
                                    <button class="symbol-btn" data-symbol="‚àÖ" title="Conjunto vac√≠o">‚àÖ</button>
                                    <button class="symbol-btn" data-symbol="‚àû" title="Infinito">‚àû</button>
                                </div>
                                
                                <h6 class="mb-2">Operadores L√≥gicos</h6>
                                <div class="symbols-grid mb-3">
                                    <button class="symbol-btn" data-symbol="‚àß" title="Y l√≥gico">‚àß</button>
                                    <button class="symbol-btn" data-symbol="‚à®" title="O l√≥gico">‚à®</button>
                                    <button class="symbol-btn" data-symbol="¬¨" title="Negaci√≥n">¬¨</button>
                                    <button class="symbol-btn" data-symbol="‚Üí" title="Implica">‚Üí</button>
                                    <button class="symbol-btn" data-symbol="‚Üî" title="Si y solo si">‚Üî</button>
                                    <button class="symbol-btn" data-symbol="‚äï" title="XOR">‚äï</button>
                                    <button class="symbol-btn" data-symbol="‚â°" title="Equivalente">‚â°</button>
                                    <button class="symbol-btn" data-symbol="‚ä•" title="Contradicci√≥n">‚ä•</button>
                                </div>
                                
                                <h6 class="mb-2">Comparaciones</h6>
                                <div class="symbols-grid mb-3">
                                    <button class="symbol-btn" data-symbol="‚â§" title="Menor o igual">‚â§</button>
                                    <button class="symbol-btn" data-symbol="‚â•" title="Mayor o igual">‚â•</button>
                                    <button class="symbol-btn" data-symbol="‚â†" title="Diferente">‚â†</button>
                                    <button class="symbol-btn" data-symbol="‚âà" title="Aproximadamente">‚âà</button>
                                    <button class="symbol-btn" data-symbol="‚àù" title="Proporcional">‚àù</button>
                                    <button class="symbol-btn" data-symbol="‚à£" title="Divide">‚à£</button>
                                    <button class="symbol-btn" data-symbol="‚à£‚à£" title="Paralelo">‚à£‚à£</button>
                                    <button class="symbol-btn" data-symbol="‚ä•" title="Perpendicular">‚ä•</button>
                                </div>
                                
                                <h6 class="mb-2">Expresiones Matem√°ticas</h6>
                                <div class="expressions-list">
                                    <button class="expression-btn" data-expression="‚à£R1‚à™R2‚à£" title="Cardinalidad de uni√≥n">
                                        Cardinalidad uni√≥n
                                    </button>
                                    <button class="expression-btn" data-expression="‚à£R1‚à©R2‚à£" title="Cardinalidad de intersecci√≥n">
                                        Cardinalidad intersecci√≥n
                                    </button>
                                    <button class="expression-btn" data-expression="‚à£R1‚àíR2‚à£" title="Cardinalidad de diferencia">
                                        Cardinalidad diferencia
                                    </button>
                                    <button class="expression-btn" data-expression="‚à£R1√óR2‚à£=n√óm" title="Cardinalidad producto cartesiano">
                                        Producto cartesiano
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentConversationId = null;
let isProcessing = false;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Auto-select first subject if available
    const subjectSelect = document.getElementById('subjectSelect');
    if (subjectSelect.options.length > 1) {
        subjectSelect.selectedIndex = 1;
    }
    
    // Focus on message input
    document.getElementById('messageInput').focus();
    
    // Handle Enter key in textarea
    document.getElementById('messageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('chatForm').dispatchEvent(new Event('submit'));
        }
    });
});

// Handle chat form submission
document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (isProcessing) return;
    
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const btnText = sendBtn.querySelector('.btn-text');
    const spinner = sendBtn.querySelector('.spinner-border');
    const subjectSelect = document.getElementById('subjectSelect');
    
    const message = messageInput.value.trim();
    const subject = subjectSelect.value;
    
    if (!message) return;
    
    // Check if subject is selected
    if (!subject) {
        alert('Por favor, selecciona una materia antes de enviar tu mensaje.');
        subjectSelect.focus();
        return;
    }
    
    isProcessing = true;
    
    // Show user message
    addMessage(message, 'user');
    
    // Clear input and show loading state
    messageInput.value = '';
    sendBtn.disabled = true;
    btnText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    spinner.classList.remove('d-none');
    
    // Show thinking indicator
    showProgress('ü§î LUCA est√° pensando...');
    
    try {
        console.log(`üéØ Sending message: ${message}`);
        console.log(`üéØ Subject: ${subject}`);
        console.log(`üéØ Conversation: ${currentConversationId}`);
        
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                subject: subject,
                conversation_id: currentConversationId,
                use_conversation_memory: usingExistingConversation  // Only true when selected from list
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update conversation ID if a new one was created
            if (result.conversation_id && !currentConversationId) {
                currentConversationId = result.conversation_id;
                usingExistingConversation = false;  // Reset flag for new conversation
                console.log(`üìù New conversation created: ${currentConversationId}`);
                console.log(`üíæ Session used: ${result.session_id_used}`);
                
                // Update conversations list without reloading the page
                refreshConversationsList();
            }
            
            // Show progress steps
            if (result.progress_steps) {
                for (const step of result.progress_steps) {
                    showProgress(`ü§î ${step}`);
                    await new Promise(resolve => setTimeout(resolve, 500)); // Small delay for UX
                }
            }
            
            // Show final response
            addMessage(result.content, 'assistant');
            console.log('‚úÖ Message processed successfully');
        } else {
            addMessage(`Error: ${result.error}`, 'assistant', 'error');
            console.error('‚ùå Chat error:', result.error);
        }
    } catch (error) {
        console.error('‚ùå Network error:', error);
        addMessage('Error de conexi√≥n. Por favor, intenta nuevamente.', 'assistant', 'error');
    } finally {
        isProcessing = false;
        sendBtn.disabled = false;
        btnText.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar';
        spinner.classList.add('d-none');
        clearProgress();
        messageInput.focus();
    }
});

function addMessage(content, role, type = 'normal') {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    
    if (role === 'user') {
        messageDiv.className = 'message-user';
    } else {
        messageDiv.className = 'message-assistant';
        if (type === 'error') {
            messageDiv.style.backgroundColor = '#f8d7da';
            messageDiv.style.borderLeftColor = '#dc3545';
        }
    }
    
    // Replace literal \n\n and \n sequences with HTML line breaks
    const formattedContent = content
        .replace(/\\n\\n/g, '<br><br>')  // Replace literal \n\n with double line breaks
        .replace(/\\n/g, '<br>')         // Replace literal \n with single line breaks
        .replace(/\n\n/g, '<br><br>')    // Replace actual \n\n with double line breaks
        .replace(/\n/g, '<br>');         // Replace actual \n with single line breaks
    
    messageDiv.innerHTML = formattedContent;
    chatContainer.appendChild(messageDiv);
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function showProgress(text) {
    const progressContainer = document.getElementById('progressContainer');
    progressContainer.innerHTML = `<div class="thinking-indicator">${text}</div>`;
}

function clearProgress() {
    const progressContainer = document.getElementById('progressContainer');
    progressContainer.innerHTML = '';
}

// Flag to track if we're using an existing conversation from the list
let usingExistingConversation = false;

function selectConversation(conversationId) {
    currentConversationId = conversationId;
    usingExistingConversation = true;  // Mark that we're using existing conversation
    
    // Update active conversation in UI
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-id="${conversationId}"]`).classList.add('active');
    
    // Clear current chat and show loading
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Cargando conversaci√≥n...</p>
        </div>
    `;
    
    // Load conversation history
    loadConversationHistory(conversationId);
    
    console.log(`üìÇ Selected existing conversation: ${conversationId}`);
}

function loadConversationHistory(conversationId) {
    fetch(`/conversations/${conversationId}/messages`)
    .then(response => response.json())
    .then(result => {
        const chatContainer = document.getElementById('chatContainer');
        
        if (result.success && result.messages.length > 0) {
            // Clear loading message
            chatContainer.innerHTML = '';
            
            // Add conversation history
            result.messages.forEach(msg => {
                addMessage(msg.content, msg.role);
            });
            
            console.log(`üìã Loaded ${result.messages.length} messages for conversation ${conversationId}`);
        } else {
            // Show empty conversation message
            chatContainer.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-comment-dots fa-2x mb-2"></i>
                    <p>Conversaci√≥n cargada. Contin√∫a donde lo dejaste.</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading conversation history:', error);
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>Error cargando la conversaci√≥n. Intenta nuevamente.</p>
            </div>
        `;
    });
}

function createNewConversation() {
    const subject = document.getElementById('subjectSelect').value;
    
    if (!subject) {
        alert('Por favor, selecciona una materia antes de crear una nueva conversaci√≥n.');
        return;
    }
    
    // Reset flags for new conversation
    currentConversationId = null;
    usingExistingConversation = false;
    
    fetch('/conversations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: `Conversaci√≥n sobre ${subject}`,
            subject: subject
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Reload conversations list
            location.reload();
        } else {
            alert('Error al crear la conversaci√≥n: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error creating conversation:', error);
        alert('Error de conexi√≥n al crear la conversaci√≥n.');
    });
}

function logout() {
    fetch('/logout')
    .then(() => {
        window.location.href = '/';
    })
    .catch(error => {
        console.error('Logout error:', error);
        window.location.href = '/';
    });
}

function refreshConversationsList() {
    fetch('/conversations')
    .then(response => response.json())
    .then(conversations => {
        const conversationsContainer = document.getElementById('conversationsList');
        
        // Clear current conversations
        conversationsContainer.innerHTML = '';
        
        // Add updated conversations
        conversations.forEach(conv => {
            const convDiv = document.createElement('div');
            convDiv.className = 'conversation-item';
            convDiv.setAttribute('data-id', conv.id);
            convDiv.onclick = () => selectConversation(conv.id);
            
            const title = conv.title.length > 60 ? conv.title.substring(0, 60) + '...' : conv.title;
            const subject = conv.subject || 'Sin materia';
            const messageCount = conv.message_count || 0;
            
            convDiv.innerHTML = `
                <div class="fw-bold">${title}</div>
                <small class="text-muted">
                    ${subject} ‚Ä¢ ${messageCount} mensajes
                </small>
            `;
            
            conversationsContainer.appendChild(convDiv);
            
            // Mark as active if it's the current conversation
            if (conv.id === currentConversationId) {
                convDiv.classList.add('active');
            }
        });
        
        console.log('üìã Conversations list refreshed');
    })
    .catch(error => {
        console.error('Error refreshing conversations:', error);
    });
}

// Symbol insertion functionality
document.addEventListener('DOMContentLoaded', function() {
    // Handle symbol button clicks
    document.querySelectorAll('.symbol-btn').forEach(button => {
        button.addEventListener('click', function() {
            const symbol = this.getAttribute('data-symbol');
            insertTextAtCursor(symbol);
            
            // Visual feedback
            this.style.transform = 'scale(0.95)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });
    
    // Handle expression button clicks
    document.querySelectorAll('.expression-btn').forEach(button => {
        button.addEventListener('click', function() {
            const expression = this.getAttribute('data-expression');
            insertTextAtCursor(expression);
            
            // Visual feedback
            this.style.transform = 'translateX(4px)';
            setTimeout(() => {
                this.style.transform = '';
            }, 150);
        });
    });
});

function insertTextAtCursor(text) {
    const messageInput = document.getElementById('messageInput');
    const start = messageInput.selectionStart;
    const end = messageInput.selectionEnd;
    const currentValue = messageInput.value;
    
    // Insert text at cursor position
    const newValue = currentValue.substring(0, start) + text + currentValue.substring(end);
    messageInput.value = newValue;
    
    // Update cursor position
    const newCursorPosition = start + text.length;
    messageInput.setSelectionRange(newCursorPosition, newCursorPosition);
    
    // Focus back on the input
    messageInput.focus();
    
    // Trigger input event to handle any form validation
    messageInput.dispatchEvent(new Event('input', { bubbles: true }));
    
    console.log(`üìù Inserted: ${text}`);
}

// Add copy to clipboard functionality for expressions
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(function() {
        console.log('‚úÖ Copied to clipboard: ' + text);
        
        // Show temporary feedback
        showTemporaryFeedback('Copiado al portapapeles');
    }, function(err) {
        console.error('‚ùå Could not copy text: ', err);
        
        // Fallback for older browsers
        const textArea = document.createElement('textarea');
        textArea.value = text;
        document.body.appendChild(textArea);
        textArea.select();
        try {
            document.execCommand('copy');
            showTemporaryFeedback('Copiado al portapapeles');
        } catch (err) {
            console.error('‚ùå Fallback copy failed: ', err);
        }
        document.body.removeChild(textArea);
    });
}

function showTemporaryFeedback(message) {
    const feedback = document.createElement('div');
    feedback.className = 'alert alert-success position-fixed';
    feedback.style.cssText = `
        top: 20px;
        right: 20px;
        z-index: 9999;
        padding: 0.5rem 1rem;
        font-size: 0.9rem;
        opacity: 0;
        transition: opacity 0.3s;
    `;
    feedback.textContent = message;
    
    document.body.appendChild(feedback);
    
    // Fade in
    setTimeout(() => {
        feedback.style.opacity = '1';
    }, 10);
    
    // Fade out and remove
    setTimeout(() => {
        feedback.style.opacity = '0';
        setTimeout(() => {
            if (feedback.parentNode) {
                feedback.parentNode.removeChild(feedback);
            }
        }, 300);
    }, 2000);
}

// Add right-click context menu for expressions (optional)
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.expression-btn').forEach(button => {
        button.addEventListener('contextmenu', function(e) {
            e.preventDefault();
            const expression = this.getAttribute('data-expression');
            copyToClipboard(expression);
        });
    });
});
</script>
{% endblock %}