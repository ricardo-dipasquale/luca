{% extends "base.html" %}

{% block title %}Chat - LUCA{% endblock %}

{% block content %}
<div class="header-brand">
    <div class="container">
        <div class="row align-items-center">
            <div class="col">
                <div class="d-flex align-items-center">
                    <h2 class="mb-0">LUCA - Asistente Educativo</h2>
                </div>
            </div>
            <div class="col-auto">
                <span class="me-3">{{ user_email }}</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Salir
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container-fluid mt-3">
    <div class="row">
        <!-- Sidebar -->
        <div class="col-md-3">
            <!-- FICA Logo -->
            <div class="text-center mb-3">
                <img src="{{ url_for('static', filename='images/Logo FICA uso excepcional color.png') }}" alt="FICA Logo" style="height: 100px;">
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-comments"></i> Conversaciones</h5>
                    <button class="btn btn-primary btn-sm w-100 mt-2" onclick="createNewConversation()">
                        <i class="fas fa-plus"></i> Nueva Conversaci√≥n
                    </button>
                </div>
                <div class="card-body" id="conversationsList">
                    {% for conv in conversations %}
                    <div class="conversation-item" data-id="{{ conv.id }}" onclick="selectConversation('{{ conv.id }}')">
                        <div class="fw-bold">{{ conv.title[:30] }}{% if conv.title|length > 30 %}...{% endif %}</div>
                        <small class="text-muted">
                            {{ conv.subject or 'Sin materia' }} ‚Ä¢ {{ conv.message_count }} mensajes
                        </small>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        
        <!-- Main Chat Area -->
        <div class="col-md-9">
            <div class="card">
                <div class="card-header">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="d-flex align-items-center">
                                <img src="{{ url_for('static', filename='images/logo luca.png') }}" alt="LUCA Logo" class="me-2" style="height: 120px;">
                                <h5 class="mb-0">LUCA - Chat de la Facultad de Ingenier√≠a y Ciencias Agrarias - Seleccion√° la materia</h5>
                            </div>
                        </div>
                        <div class="col-auto">
                            <select class="form-select form-select-sm" id="subjectSelect">
                                <option value="">Selecciona una materia...</option>
                                {% for subject in subjects %}
                                <option value="{{ subject }}">{{ subject }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Chat Messages Container -->
                    <div class="chat-container" id="chatContainer">
                        <div class="text-center text-muted">
                            <i class="fas fa-comment-dots fa-2x mb-2"></i>
                            <p>¬°Hola! Soy LUCA, tu asistente. ¬øEn qu√© puedo ayudarte hoy?</p>
                        </div>
                    </div>
                    
                    <!-- Progress Container -->
                    <div class="progress-container" id="progressContainer"></div>
                    
                    <!-- Chat Input -->
                    <form id="chatForm" class="mt-3">
                        <div class="input-group">
                            <textarea class="form-control" id="messageInput" rows="2" 
                                      placeholder="Escribe tu pregunta aqu√≠..." required></textarea>
                            <button class="btn btn-primary" type="submit" id="sendBtn">
                                <span class="btn-text"><i class="fas fa-paper-plane"></i> Enviar</span>
                                <span class="spinner-border spinner-border-sm d-none" role="status"></span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
let currentConversationId = null;
let isProcessing = false;

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    // Auto-select first subject if available
    const subjectSelect = document.getElementById('subjectSelect');
    if (subjectSelect.options.length > 1) {
        subjectSelect.selectedIndex = 1;
    }
    
    // Focus on message input
    document.getElementById('messageInput').focus();
    
    // Handle Enter key in textarea
    document.getElementById('messageInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            document.getElementById('chatForm').dispatchEvent(new Event('submit'));
        }
    });
});

// Handle chat form submission
document.getElementById('chatForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    if (isProcessing) return;
    
    const messageInput = document.getElementById('messageInput');
    const sendBtn = document.getElementById('sendBtn');
    const btnText = sendBtn.querySelector('.btn-text');
    const spinner = sendBtn.querySelector('.spinner-border');
    const subjectSelect = document.getElementById('subjectSelect');
    
    const message = messageInput.value.trim();
    const subject = subjectSelect.value;
    
    if (!message) return;
    
    // Check if subject is selected
    if (!subject) {
        alert('Por favor, selecciona una materia antes de enviar tu mensaje.');
        subjectSelect.focus();
        return;
    }
    
    isProcessing = true;
    
    // Show user message
    addMessage(message, 'user');
    
    // Clear input and show loading state
    messageInput.value = '';
    sendBtn.disabled = true;
    btnText.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Procesando...';
    spinner.classList.remove('d-none');
    
    // Show thinking indicator
    showProgress('ü§î LUCA est√° pensando...');
    
    try {
        console.log(`üéØ Sending message: ${message}`);
        console.log(`üéØ Subject: ${subject}`);
        console.log(`üéØ Conversation: ${currentConversationId}`);
        
        const response = await fetch('/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                subject: subject,
                conversation_id: currentConversationId,
                use_conversation_memory: usingExistingConversation  // Only true when selected from list
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Update conversation ID if a new one was created
            if (result.conversation_id && !currentConversationId) {
                currentConversationId = result.conversation_id;
                usingExistingConversation = false;  // Reset flag for new conversation
                console.log(`üìù New conversation created: ${currentConversationId}`);
                console.log(`üíæ Session used: ${result.session_id_used}`);
                
                // Update conversations list without reloading the page
                refreshConversationsList();
            }
            
            // Show progress steps
            if (result.progress_steps) {
                for (const step of result.progress_steps) {
                    showProgress(`ü§î ${step}`);
                    await new Promise(resolve => setTimeout(resolve, 500)); // Small delay for UX
                }
            }
            
            // Show final response
            addMessage(result.content, 'assistant');
            console.log('‚úÖ Message processed successfully');
        } else {
            addMessage(`Error: ${result.error}`, 'assistant', 'error');
            console.error('‚ùå Chat error:', result.error);
        }
    } catch (error) {
        console.error('‚ùå Network error:', error);
        addMessage('Error de conexi√≥n. Por favor, intenta nuevamente.', 'assistant', 'error');
    } finally {
        isProcessing = false;
        sendBtn.disabled = false;
        btnText.innerHTML = '<i class="fas fa-paper-plane"></i> Enviar';
        spinner.classList.add('d-none');
        clearProgress();
        messageInput.focus();
    }
});

function addMessage(content, role, type = 'normal') {
    const chatContainer = document.getElementById('chatContainer');
    const messageDiv = document.createElement('div');
    
    if (role === 'user') {
        messageDiv.className = 'message-user';
    } else {
        messageDiv.className = 'message-assistant';
        if (type === 'error') {
            messageDiv.style.backgroundColor = '#f8d7da';
            messageDiv.style.borderLeftColor = '#dc3545';
        }
    }
    
    // Replace literal \n\n and \n sequences with HTML line breaks
    const formattedContent = content
        .replace(/\\n\\n/g, '<br><br>')  // Replace literal \n\n with double line breaks
        .replace(/\\n/g, '<br>')         // Replace literal \n with single line breaks
        .replace(/\n\n/g, '<br><br>')    // Replace actual \n\n with double line breaks
        .replace(/\n/g, '<br>');         // Replace actual \n with single line breaks
    
    messageDiv.innerHTML = formattedContent;
    chatContainer.appendChild(messageDiv);
    
    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

function showProgress(text) {
    const progressContainer = document.getElementById('progressContainer');
    progressContainer.innerHTML = `<div class="thinking-indicator">${text}</div>`;
}

function clearProgress() {
    const progressContainer = document.getElementById('progressContainer');
    progressContainer.innerHTML = '';
}

// Flag to track if we're using an existing conversation from the list
let usingExistingConversation = false;

function selectConversation(conversationId) {
    currentConversationId = conversationId;
    usingExistingConversation = true;  // Mark that we're using existing conversation
    
    // Update active conversation in UI
    document.querySelectorAll('.conversation-item').forEach(item => {
        item.classList.remove('active');
    });
    document.querySelector(`[data-id="${conversationId}"]`).classList.add('active');
    
    // Clear current chat and show loading
    const chatContainer = document.getElementById('chatContainer');
    chatContainer.innerHTML = `
        <div class="text-center text-muted">
            <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
            <p>Cargando conversaci√≥n...</p>
        </div>
    `;
    
    // Load conversation history
    loadConversationHistory(conversationId);
    
    console.log(`üìÇ Selected existing conversation: ${conversationId}`);
}

function loadConversationHistory(conversationId) {
    fetch(`/conversations/${conversationId}/messages`)
    .then(response => response.json())
    .then(result => {
        const chatContainer = document.getElementById('chatContainer');
        
        if (result.success && result.messages.length > 0) {
            // Clear loading message
            chatContainer.innerHTML = '';
            
            // Add conversation history
            result.messages.forEach(msg => {
                addMessage(msg.content, msg.role);
            });
            
            console.log(`üìã Loaded ${result.messages.length} messages for conversation ${conversationId}`);
        } else {
            // Show empty conversation message
            chatContainer.innerHTML = `
                <div class="text-center text-muted">
                    <i class="fas fa-comment-dots fa-2x mb-2"></i>
                    <p>Conversaci√≥n cargada. Contin√∫a donde lo dejaste.</p>
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error loading conversation history:', error);
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.innerHTML = `
            <div class="text-center text-muted">
                <i class="fas fa-exclamation-triangle fa-2x mb-2"></i>
                <p>Error cargando la conversaci√≥n. Intenta nuevamente.</p>
            </div>
        `;
    });
}

function createNewConversation() {
    const subject = document.getElementById('subjectSelect').value;
    
    if (!subject) {
        alert('Por favor, selecciona una materia antes de crear una nueva conversaci√≥n.');
        return;
    }
    
    // Reset flags for new conversation
    currentConversationId = null;
    usingExistingConversation = false;
    
    fetch('/conversations', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            title: `Conversaci√≥n sobre ${subject}`,
            subject: subject
        })
    })
    .then(response => response.json())
    .then(result => {
        if (result.success) {
            // Reload conversations list
            location.reload();
        } else {
            alert('Error al crear la conversaci√≥n: ' + result.error);
        }
    })
    .catch(error => {
        console.error('Error creating conversation:', error);
        alert('Error de conexi√≥n al crear la conversaci√≥n.');
    });
}

function logout() {
    fetch('/logout')
    .then(() => {
        window.location.href = '/';
    })
    .catch(error => {
        console.error('Logout error:', error);
        window.location.href = '/';
    });
}

function refreshConversationsList() {
    fetch('/conversations')
    .then(response => response.json())
    .then(conversations => {
        const conversationsContainer = document.getElementById('conversationsList');
        
        // Clear current conversations
        conversationsContainer.innerHTML = '';
        
        // Add updated conversations
        conversations.forEach(conv => {
            const convDiv = document.createElement('div');
            convDiv.className = 'conversation-item';
            convDiv.setAttribute('data-id', conv.id);
            convDiv.onclick = () => selectConversation(conv.id);
            
            const title = conv.title.length > 30 ? conv.title.substring(0, 30) + '...' : conv.title;
            const subject = conv.subject || 'Sin materia';
            const messageCount = conv.message_count || 0;
            
            convDiv.innerHTML = `
                <div class="fw-bold">${title}</div>
                <small class="text-muted">
                    ${subject} ‚Ä¢ ${messageCount} mensajes
                </small>
            `;
            
            conversationsContainer.appendChild(convDiv);
            
            // Mark as active if it's the current conversation
            if (conv.id === currentConversationId) {
                convDiv.classList.add('active');
            }
        });
        
        console.log('üìã Conversations list refreshed');
    })
    .catch(error => {
        console.error('Error refreshing conversations:', error);
    });
}
</script>
{% endblock %}